pipeline {
    agent any

    environment {

        //Credentials for Azure CLI Login
        AZ_USER=credentials('DEV_USER')
        AZ_PWD=credentials('DEV_PWD')
        AZ_TENANT=credentials('DEV_TENANT')

        //Variables for pipeline building (image, registry)
        IMAGE_NAME="trading-app:${BUILD_NUMBER}"
        ACR_NAME='acrjarviscalvin'

        //Variables for pipeline deployment (resource group, cluster, acr docker repo, deployment)
        RESOURCE_GROUP='rg-trading-app-aks'
        CLUSTER_NAME='aks-trading-app'
        DOCKER_REPO='acrjarviscalvin.azurecr.io'
        DEPLOYMENT_NAME='deployment.apps/trading-app'
    }

    stages {
        stage('Init') {
            steps {
                sh 'az login --service-principal --username ${AZ_USER} --password ${AZ_PWD} --tenant ${AZ_TENANT}'
            }
        }
        stage('Build') {
            steps {
                sh 'az acr build --image ${IMAGE_NAME} --registry ${ACR_NAME} --file Dockerfile .'
            }
        }
        stage('Deploy') {
            steps {
                sh 'az aks get-credentials --name ${CLUSTER_NAME} --resource-group ${RESOURCE_GROUP}'
                sh 'kubectl set image ${DEPLOYMENT_NAME} trading-app-dev=${DOCKER_REPO}/${IMAGE_NAME}'
            }
        }
    }
}